{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}BookReview.vn - Kh√°m ph√°, ƒë√°nh gi√° v√† chia s·∫ª s√°ch hay{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}ƒë√°nh gi√° s√°ch, review s√°ch, s√°ch hay, reading, books{% endblock %}">
    <meta property="og:title" content="{% block og_title %}BookReview.vn{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Kh√°m ph√°, ƒë√°nh gi√° v√† chia s·∫ª s√°ch hay{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:image" content="{% block og_image %}{% static 'images/og-default.jpg' %}{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}">
    <meta name="twitter:card" content="summary_large_image">
    {% block canonical_url %}<link rel="canonical" href="{{ request.build_absolute_uri }}">{% endblock %}
    
    <title>{% block title %}BookReview.vn - ƒê√°nh gi√° s√°ch{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#2563eb',
              'primary-hover': '#1d4ed8',
              'primary-light': '#3b82f6',
            }
          }
        },
        plugins: []
      }
    </script>
    
    <!-- DaisyUI CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Heroicons (via CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@heroicons/react@2.0.18/24/outline/index.js" type="module"></script>
    
    <!-- AOS (Animate On Scroll) -->
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
    
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/tailwind-extras.css' %}">
    <link rel="stylesheet" href="{% static 'css/ux-improvements.css' %}">
    <link rel="stylesheet" href="{% static 'css/daisyui-custom.css' %}">
    <link rel="stylesheet" href="{% static 'css/animations.css' %}">
    <link rel="stylesheet" href="{% static 'css/color-improvements.css' %}">
    <link rel="stylesheet" href="{% static 'css/backgrounds.css' %}">
    <link rel="stylesheet" href="{% static 'css/ios-glass.css' %}">
    <link rel="stylesheet" href="{% static 'css/modern-ui.css' %}">
    <link rel="stylesheet" href="{% static 'css/genre-pages.css' %}">
    <link rel="stylesheet" href="{% static 'css/global-improvements.css' %}">
    <link rel="stylesheet" href="{% static 'css/hero-search.css' %}">
    <link rel="stylesheet" href="{% static 'css/comments.css' %}">
    <link rel="stylesheet" href="{% static 'css/notifications.css' %}">
    <link rel="stylesheet" href="{% static 'css/holiday-theme.css' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'images/favicon.svg' %}">
    <link rel="alternate icon" type="image/x-icon" href="{% static 'images/favicon.svg' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body class="christmas-mode {% block body_class %}{% endblock %}">
    <!-- Navigation Header -->
    <nav class="shadow-sm sticky top-0 z-50 animate-slide-down" role="navigation" aria-label="Main navigation" data-aos="fade-down" style="background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(30px) saturate(200%); -webkit-backdrop-filter: blur(30px) saturate(200%);">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <a href="{% url 'home' %}" class="flex items-center space-x-2 text-gray-700 hover:text-primary transition-all duration-300 hover:scale-105" aria-label="BookReview.vn Home">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-primary animate-float">
                            <path d="M6 4C5.44772 4 5 4.44772 5 5V27C5 27.5523 5.44772 28 6 28H26C26.5523 28 27 27.5523 27 27V5C27 4.44772 26.5523 4 26 4H6Z" fill="currentColor"/>
                            <path d="M9 8H19M9 12H23M9 16H20M9 20H18" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span class="font-bold text-xl bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">BookReview.vn</span>
                    </a>
                </div>
                
                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-1">
                    <a href="{% url 'home' %}" class="px-4 py-2 text-gray-700 hover:text-primary hover:bg-white rounded-lg transition-all duration-300 font-medium nav-link-animated hover:scale-105">Trang ch·ªß</a>
                    <a href="{% url 'explore' %}" class="px-4 py-2 text-gray-700 hover:text-primary hover:bg-white rounded-lg transition-all duration-300 font-medium nav-link-animated hover:scale-105">Kh√°m ph√°</a>
                    <a href="{% url 'book_list_view' %}" class="px-4 py-2 text-gray-700 hover:text-primary hover:bg-white rounded-lg transition-all duration-300 font-medium nav-link-animated hover:scale-105">S√°ch</a>
                    <a href="{% url 'review_list_frontend' %}" class="px-4 py-2 text-gray-700 hover:text-primary hover:bg-white rounded-lg transition-all duration-300 font-medium nav-link-animated hover:scale-105">Reviews</a>
                </div>
                
                <!-- Search Bar -->
                <div class="hidden lg:flex flex-1 max-w-md mx-8">
                    <form class="relative w-full flex items-center gap-2" action="{% url 'search' %}" method="get" role="search">
                        <div class="relative flex-1">
                        <input 
                            type="search" 
                            name="q" 
                            placeholder="T√¨m ki·∫øm s√°ch, t√°c gi·∫£..." 
                            aria-label="T√¨m ki·∫øm"
                                class="form-input w-full pl-4 pr-4"
                            id="main-search"
                        >
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm flex-shrink-0">
                            <span class="hidden xl:inline">T√¨m ki·∫øm</span>
                        </button>
                    </form>
                </div>
                
                <!-- User Actions -->
                <div class="flex items-center space-x-3">
                    <a href="{% if user.is_authenticated %}{% url 'user_shelves' %}{% else %}{% url 'login' %}?next={% url 'user_shelves' %}{% endif %}" class="hidden lg:inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 text-sm font-medium text-gray-600 hover:text-primary hover:border-primary hover:bg-white transition-all glass-button">
                        <i class="fas fa-layer-group text-primary"></i>
                        <span>K·ªá s√°ch</span>
                    </a>
                    {% if user.is_authenticated %}
                        <a href="{% url 'notifications' %}" class="relative p-2 text-gray-600 hover:text-primary hover:bg-white rounded-lg transition-all" aria-label="Th√¥ng b√°o">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="notification-badge" id="notification-count" style="display: none;">
                                <span class="notification-count-number">0</span>
                            </span>
                        </a>
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" @click.away="open = false" class="flex items-center space-x-2 p-1 rounded-lg hover:bg-white transition-all" aria-label="Menu ng∆∞·ªùi d√πng">
                                <img src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}{% static 'images/default-avatar.svg' %}{% endif %}" 
                                     alt="{{ user.username }}" class="w-8 h-8 rounded-full object-cover">
                                <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                            </button>
                            <div x-show="open" 
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="transform opacity-0 scale-95"
                                 x-transition:enter-end="transform opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="transform opacity-100 scale-100"
                                 x-transition:leave-end="transform opacity-0 scale-95"
                                 class="absolute right-0 mt-2 w-48 rounded-lg shadow-xl py-1 z-50"
                                 style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(30px) saturate(200%); -webkit-backdrop-filter: blur(30px) saturate(200%); border: 1px solid rgba(226, 232, 240, 0.6);">
                                <a href="{% url 'user_profile' user.username %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors"><i class="fas fa-user mr-2"></i>H·ªì s∆° c·ªßa t√¥i</a>
                                <a href="{% url 'user_shelves' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors"><i class="fas fa-book mr-2"></i>K·ªá s√°ch</a>
                                <a href="{% url 'settings' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors"><i class="fas fa-cog mr-2"></i>C√†i ƒë·∫∑t</a>
                                <hr class="my-1">
                                <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng xu·∫•t</a>
                            </div>
                        </div>
                    {% else %}
                        <a href="{% url 'login' %}" class="btn btn-outline hidden sm:inline-flex">
                            <span>ƒêƒÉng nh·∫≠p</span>
                        </a>
                        <a href="{% url 'register' %}" class="btn btn-primary">
                            <span>ƒêƒÉng k√Ω</span>
                        </a>
                    {% endif %}
                    
                    <!-- Mobile Menu Toggle -->
                    <button class="md:hidden p-2 text-gray-600 hover:text-primary hover:bg-white rounded-lg transition-all" aria-label="Toggle menu" aria-expanded="false" id="mobile-menu-btn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div class="hidden md:hidden border-t border-gray-200" id="mobile-menu">
                <div class="px-4 py-3 space-y-1">
                    <a href="{% url 'home' %}" class="block px-3 py-2 text-gray-700 hover:bg-white rounded-lg transition-colors font-medium">Trang ch·ªß</a>
                    <a href="{% url 'explore' %}" class="block px-3 py-2 text-gray-700 hover:bg-white rounded-lg transition-colors font-medium">Kh√°m ph√°</a>
                    <a href="{% url 'book_list_view' %}" class="block px-3 py-2 text-gray-700 hover:bg-white rounded-lg transition-colors font-medium">S√°ch</a>
                    <a href="{% url 'review_list_frontend' %}" class="block px-3 py-2 text-gray-700 hover:bg-white rounded-lg transition-colors font-medium">Reviews</a>
                    {% if user.is_authenticated %}
                        <hr class="my-2">
                        <a href="{% url 'user_profile' user.username %}" class="block px-3 py-2 text-gray-700 hover:bg-white rounded-lg transition-colors">H·ªì s∆°</a>
                        <a href="{% url 'user_shelves' %}" class="block px-3 py-2 text-gray-700 hover:bg-white rounded-lg transition-colors">K·ªá s√°ch</a>
                        <a href="{% url 'settings' %}" class="block px-3 py-2 text-gray-700 hover:bg-white rounded-lg transition-colors">C√†i ƒë·∫∑t</a>
                        <a href="{% url 'logout' %}" class="block px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">ƒêƒÉng xu·∫•t</a>
                    {% else %}
                        <hr class="my-2">
                        <a href="{% url 'login' %}?next={% url 'user_shelves' %}" class="block px-3 py-2 text-gray-700 hover:bg-white rounded-lg transition-colors font-medium">K·ªá s√°ch</a>
                        <a href="{% url 'login' %}" class="btn btn-outline w-full justify-center">ƒêƒÉng nh·∫≠p</a>
                        <a href="{% url 'register' %}" class="btn btn-primary w-full justify-center">ƒêƒÉng k√Ω</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
    
    <div class="holiday-banner" role="status" aria-live="polite">
        <div class="container mx-auto px-4">
            <div class="holiday-banner__content">
                <div>
                    <p class="holiday-badge">üéÑ M√πa l·ªÖ h·ªôi</p>
                    <h2>Lan t·ªèa tinh th·∫ßn Gi√°ng sinh c√πng BookReview.vn</h2>
                    <p>Trang tr√≠ k·ªá s√°ch, chia s·∫ª review ·∫•m √°p v√† kh√°m ph√° qu√† t·∫∑ng tri th·ª©c cho ng∆∞·ªùi th√¢n.</p>
                </div>
                <div class="holiday-banner__actions">
                    <a href="{% url 'explore' %}" class="btn btn-primary btn-sm">Kh√°m ph√° qu√† t·∫∑ng</a>
                    <a href="{% url 'review_list_frontend' %}" class="btn btn-outline btn-sm">Vi·∫øt ƒë√°nh gi√°</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="holiday-snow" aria-hidden="true">
        {% for _ in "12345678901234567890" %}
        <span></span>
        {% endfor %}
    </div>
    
    <!-- Main Content -->
    <main class="min-h-screen">
        {% if messages %}
            <div class="fixed top-20 right-4 z-50 space-y-2 max-w-md" id="messages-container">
                {% for message in messages %}
                    <div class="bg-white rounded-lg shadow-lg p-4 border-l-4 {% if message.tags == 'error' %}border-red-500{% elif message.tags == 'success' %}border-green-500{% elif message.tags == 'warning' %}border-yellow-500{% else %}border-blue-500{% endif %} flex items-center justify-between notification-enter hover-lift" role="alert">
                        <div class="flex items-center space-x-3">
                            {% if message.tags == 'error' %}
                                <i class="fas fa-exclamation-circle text-red-500"></i>
                            {% elif message.tags == 'success' %}
                                <i class="fas fa-check-circle text-green-500"></i>
                            {% elif message.tags == 'warning' %}
                                <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                            {% else %}
                                <i class="fas fa-info-circle text-blue-500"></i>
                            {% endif %}
                            <span class="text-gray-700">{{ message }}</span>
                        </div>
                        <button class="text-gray-400 hover:text-gray-600 transition-colors ml-4" aria-label="Close" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>
    
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- AOS JS -->
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    
    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.all.min.js"></script>
    
    <!-- LazySizes -->
    <script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script>
    
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    
    <!-- DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    
    <!-- Heroicons Loader -->
    <script src="{% static 'js/heroicons-loader.js' %}"></script>
    
    <!-- Main JS -->
    <script src="{% static 'js/main.js' %}"></script>
    
    <!-- Initialize AOS -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof AOS !== 'undefined') {
          AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            offset: 100,
            delay: 0,
            disable: false,
            startEvent: 'DOMContentLoaded',
            initClassName: false,
            animatedClassName: 'aos-animate',
            useClassNames: false,
            disableMutationObserver: false,
            debounceDelay: 50,
            throttleDelay: 99
          });
        }
      });
    </script>
    
    <!-- Initialize Swiper globally if needed -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Auto-initialize Swiper instances with data-swiper attribute
        document.querySelectorAll('[data-swiper]').forEach(element => {
          const config = JSON.parse(element.getAttribute('data-swiper-config') || '{}');
          if (typeof Swiper !== 'undefined' && typeof BookReview !== 'undefined') {
            BookReview.initSwiper(element, config);
          }
        });
      });
    </script>
    
    <!-- Load Notification Count -->
    {% if user.is_authenticated %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const notificationBadge = document.getElementById('notification-count');
        if (!notificationBadge) return;
        
        function updateNotificationCount() {
          fetch('/api/social/notifications/unread-count/')
            .then(res => {
              if (!res.ok) throw new Error('Failed to fetch');
              return res.json();
            })
            .then(data => {
              const count = data.count || data.unread_count || 0;
              const countNumber = notificationBadge.querySelector('.notification-count-number');
              
              if (count > 0) {
                notificationBadge.style.display = 'flex';
                if (countNumber) {
                  countNumber.textContent = count > 99 ? '99+' : count.toString();
                  
                  // Add size classes based on count
                  notificationBadge.classList.remove('large', 'very-large');
                  if (count > 9 && count <= 99) {
                    notificationBadge.classList.add('large');
                  } else if (count > 99) {
                    notificationBadge.classList.add('very-large');
                  }
                }
              } else {
                notificationBadge.style.display = 'none';
              }
            })
            .catch(err => {
              console.error('Error loading notification count:', err);
              notificationBadge.style.display = 'none';
            });
        }
        
        // Load count on page load
        updateNotificationCount();
        
        // Refresh count every 30 seconds
        setInterval(updateNotificationCount, 30000);
      });
    </script>
    {% endif %}
    
    {% block extra_js %}{% endblock %}
</body>
</html>

