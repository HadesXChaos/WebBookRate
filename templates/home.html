{% extends 'base.html' %}
{% load static %}

{% block title %}BookReview.vn - ƒê√°nh gi√° s√°ch{% endblock %}
{% block meta_description %}Kh√°m ph√°, ƒë√°nh gi√° v√† chia s·∫ª s√°ch hay c√πng c·ªông ƒë·ªìng y√™u s√°ch{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="container">
        <h1>Kh√°m ph√° th·∫ø gi·ªõi s√°ch</h1>
        <p>Chia s·∫ª ƒë√°nh gi√°, kh√°m ph√° s√°ch hay v√† k·∫øt n·ªëi v·ªõi c·ªông ƒë·ªìng y√™u s√°ch</p>
        <form class="hero-search" action="{% url 'search' %}" method="get" role="search">
            <input 
                type="search" 
                name="q" 
                placeholder="T√¨m ki·∫øm s√°ch, t√°c gi·∫£..." 
                aria-label="T√¨m ki·∫øm"
                class="search-input"
            >
            <button type="submit" class="search-button" aria-label="T√¨m ki·∫øm">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16z" stroke="currentColor" stroke-width="2"/>
                    <path d="m19 19-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </form>
    </div>
</section>

<!-- Trending Books Section -->
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Th·ªãnh h√†nh tu·∫ßn</h2>
            <a href="{% url 'explore' %}?sort=trending" class="section-link">Xem t·∫•t c·∫£ ‚Üí</a>
        </div>
        <div class="grid grid-4" id="trending-books">
            <!-- Books will be loaded via JavaScript -->
            <div class="loading">ƒêang t·∫£i...</div>
        </div>
    </div>
</section>

<!-- New Reviews Section -->
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Reviews m·ªõi nh·∫•t</h2>
            <a href="{% url 'reviews:review_list' %}" class="section-link">Xem t·∫•t c·∫£ ‚Üí</a>
        </div>
        <div id="new-reviews">
            <!-- Reviews will be loaded via JavaScript -->
            <div class="loading">ƒêang t·∫£i...</div>
        </div>
    </div>
</section>

<!-- Recommended Books Section -->
{% if user.is_authenticated %}
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">ƒê·ªÅ xu·∫•t cho b·∫°n</h2>
            <a href="{% url 'explore' %}" class="section-link">Xem t·∫•t c·∫£ ‚Üí</a>
        </div>
        <div class="grid grid-4" id="recommended-books">
            <!-- Books will be loaded via JavaScript -->
            <div class="loading">ƒêang t·∫£i...</div>
        </div>
    </div>
</section>
{% endif %}

<!-- Popular Genres Section -->
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Th·ªÉ lo·∫°i ph·ªï bi·∫øn</h2>
            <a href="{% url 'genre_directory' %}" class="section-link">Xem t·∫•t c·∫£ ‚Üí</a>
        </div>
        <div class="grid grid-2" id="popular-genres">
            <!-- Genres will be loaded via JavaScript -->
            <div class="loading">ƒêang t·∫£i...</div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    //Load trending books
    fetch('/api/books/trending/')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('trending-books');
            
            // S·ª¨A 2: X·ª≠ l√Ω d·ªØ li·ªáu tr·∫£ v·ªÅ
            const books = Array.isArray(data) ? data : (data.results || []);

            if (books.length > 0) {
                container.innerHTML = books.slice(0, 8).map((book, index) => {
                    // S·ª¨A 3: Logic t·∫°o Huy hi·ªáu x·∫øp h·∫°ng
                    let badgeHtml = '';
                    if (index === 0) badgeHtml = '<div class="rank-badge rank-1">üèÜ 1</div>';
                    else if (index === 1) badgeHtml = '<div class="rank-badge rank-2">ü•à 2</div>';
                    else if (index === 2) badgeHtml = '<div class="rank-badge rank-3">ü•â 3</div>';
                    else badgeHtml = `<div class="rank-badge rank-normal">#${index + 1}</div>`;

                    return `
                        <div class="book-card" style="position: relative;">
                            ${badgeHtml}
                            
                            <a href="/books/${book.slug}/">
                                <div class="book-cover">
                                    <img src="${book.cover || '/static/images/default-book.svg'}" 
                                        alt="${book.title}" loading="lazy">
                                </div>
                                <div class="book-info">
                                    <h3 class="book-title">${book.title}</h3>
                                    <p class="book-author">${book.authors?.[0]?.name || 'ƒêang c·∫≠p nh·∫≠t'}</p>
                                    <div class="book-rating">
                                        <div class="rating-stars" data-rating="${book.avg_rating || 0}"></div>
                                        <span class="rating-value">${parseFloat(book.avg_rating || 0).toFixed(1)}</span>
                                        <span class="rating-count">(${book.review_count || 0})</span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    `;
                }).join('');
                
                // Render stars (Gi·ªØ nguy√™n logic c·ªßa b·∫°n)
                if (typeof BookReview !== 'undefined' && BookReview.renderStars) {
                    container.querySelectorAll('[data-rating]').forEach(el => {
                        BookReview.renderStars(parseFloat(el.dataset.rating), el);
                    });
                }
            } else {
                container.innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu th·ªãnh h√†nh tu·∫ßn n√†y.</p>';
            }
        })
        .catch(err => {
            console.error('Error loading trending books:', err);
            document.getElementById('trending-books').innerHTML = '<p>C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu.</p>';
        });

    // Load new reviews
    fetch('/api/reviews/?ordering=-created_at')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('new-reviews');
            if (data.results && data.results.length > 0) {
                container.innerHTML = data.results.slice(0, 5).map(review => `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="card-body">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                <img src="${review.user?.profile?.avatar || '/static/images/default-avatar.svg'}" 
                                     alt="${review.user?.username}" 
                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                <div>
                                    <strong><a href="/users/${review.user?.username}/">${review.user?.username}</a></strong>
                                    <span style="color: #64748b; font-size: 0.875rem;"> ƒë√°nh gi√°</span>
                                    <a href="/books/${review.book?.slug}/">${review.book?.title}</a>
                                </div>
                            </div>
                            <div class="rating-stars" data-rating="${review.rating || 0}"></div>
                            <h4 style="margin-top: 0.5rem;"><a href="/reviews/${review.id}/">${review.title}</a></h4>
                            <p style="color: #64748b; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                ${review.body_html || review.body || ''}
                            </p>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.875rem; color: #64748b;">
                                <span>${new Date(review.created_at).toLocaleDateString('vi-VN')}</span>
                                <a href="/reviews/${review.id}/#comments">üí¨ ${review.comment_count || 0} b√¨nh lu·∫≠n</a>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Render stars
                container.querySelectorAll('[data-rating]').forEach(el => {
                    BookReview.renderStars(parseFloat(el.dataset.rating), el);
                });
            } else {
                container.innerHTML = '<p>Ch∆∞a c√≥ review n√†o.</p>';
            }
        })
        .catch(err => {
            console.error('Error loading new reviews:', err);
            document.getElementById('new-reviews').innerHTML = '<p>C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu.</p>';
        });

    {% if user.is_authenticated %}
    // Load recommended books (if authenticated)
    fetch('/api/books/?ordering=-avg_rating')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('recommended-books');
            if (data.results && data.results.length > 0) {
                container.innerHTML = data.results.slice(0, 8).map(book => `
                    <div class="book-card">
                        <a href="/books/${book.slug}/">
                            <div class="book-cover">
                                <img src="${book.cover || '/static/images/default-book.svg'}" 
                                     alt="${book.title}" loading="lazy">
                            </div>
                            <div class="book-info">
                                <h3 class="book-title">${book.title}</h3>
                                <p class="book-author">${book.authors?.[0]?.name || 'N/A'}</p>
                                <div class="book-rating">
                                    <div class="rating-stars" data-rating="${book.avg_rating || 0}"></div>
                                    <span class="rating-value">${parseFloat(book.avg_rating || 0).toFixed(1)}</span>
                                </div>
                            </div>
                        </a>
                    </div>
                `).join('');
                
                // Render stars
                container.querySelectorAll('[data-rating]').forEach(el => {
                    BookReview.renderStars(parseFloat(el.dataset.rating), el);
                });
            } else {
                container.innerHTML = '<p>Ch∆∞a c√≥ s√°ch n√†o.</p>';
            }
        })
        .catch(err => {
            console.error('Error loading recommended books:', err);
        });
    {% endif %}

    // Load popular genres
    fetch('/api/books/genres/')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('popular-genres');
            if (data.results && data.results.length > 0) {
                container.innerHTML = data.results.slice(0, 6).map(genre => `
                    <a href="/books/genres/${genre.slug}/" class="card">
                        <div class="card-body">
                            <h3>${genre.name}</h3>
                            <p style="color: #64748b;">${genre.book_count || 0} cu·ªën s√°ch</p>
                        </div>
                    </a>
                `).join('');
            } else {
                container.innerHTML = '<p>Ch∆∞a c√≥ th·ªÉ lo·∫°i n√†o.</p>';
            }
        })
        .catch(err => {
            console.error('Error loading genres:', err);
        });
});


</script>
{% endblock %}

