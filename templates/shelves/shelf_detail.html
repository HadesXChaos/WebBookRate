{% extends 'base.html' %} {% load static %} {% block title %}K·ªá s√°ch -
BookReview.vn{% endblock %} {% block content %}
<div class="container" style="max-width: 1200px">
  <!-- Header k·ªá -->
  <div id="shelf-header" style="margin: 2rem 0 1.5rem 0">
    <p>ƒêang t·∫£i k·ªá s√°ch...</p>
  </div>

  <!-- Danh s√°ch s√°ch trong k·ªá -->
  <div id="shelf-books"></div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
      const shelfId = {{ shelf_id }};
      const headerEl = document.getElementById('shelf-header');
      const booksEl = document.getElementById('shelf-books');

      // Render th√¥ng tin k·ªá
      function renderShelfHeader(shelf) {
          const owner = shelf.user || {};
          const username = owner.username || '';
          const bookCount = shelf.book_count || 0;
          const visibilityLabel = shelf.visibility === 'private'
              ? 'üîí Ri√™ng t∆∞'
              : 'üåê C√¥ng khai';

          // ƒê·ªïi title tab tr√¨nh duy·ªát cho ƒë·∫πp
          if (shelf.name) {
              document.title = shelf.name + ' - BookReview.vn';
          }

          headerEl.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1.5rem;">
                  <div>
                      <h1 style="margin-bottom: 0.5rem;">${shelf.name}</h1>
                      <div style="color: #64748b; font-size: 0.95rem; margin-bottom: 0.75rem;">
                          <span>üë§ Ch·ªß s·ªü h·ªØu: </span>
                          ${username ? `<a href="/users/${username}/" style="color: #0f766e; font-weight: 500;">${username}</a>` : 'Kh√¥ng r√µ'}
                          <span style="margin: 0 0.5rem;">‚Ä¢</span>
                          <span>${visibilityLabel}</span>
                          <span style="margin: 0 0.5rem;">‚Ä¢</span>
                          <span>${bookCount} cu·ªën s√°ch</span>
                      </div>
                      ${shelf.description ? `
                          <p style="max-width: 700px; color: #475569;">${shelf.description}</p>
                      ` : ''}
                  </div>
              </div>
          `;
      }

      // Render danh s√°ch s√°ch trong k·ªá
      function renderBooks(items) {
          if (!items || items.length === 0) {
              booksEl.innerHTML = `
                  <div style="padding: 2rem 0; text-align: center; color: #64748b;">
                      <p>K·ªá n√†y ch∆∞a c√≥ cu·ªën s√°ch n√†o.</p>
                      <p>H√£y v√†o trang chi ti·∫øt s√°ch v√† b·∫•m "Th√™m v√†o k·ªá s√°ch" ƒë·ªÉ th√™m s√°ch v√†o k·ªá n√†y.</p>
                  </div>
              `;
              return;
          }

          booksEl.innerHTML = `
              <div class="grid-3">
                  ${items.map(item => {
                      const book = item.book || {};
                      const cover = book.cover || '{% static "images/default-book.svg" %}';
                      const slug = book.slug || '';
                      const title = book.title || 'Kh√¥ng r√µ t√™n s√°ch';
                      const year = book.year || '';
                      const rating = book.avg_rating || 0;
                      const ratingCount = book.rating_count || 0;
                      const authors = (book.authors || []).map(a => a.name).join(', ');

                      return `
                          <div class="card book-card">
                              <div class="card-body" style="display: flex; gap: 1rem;">
                                  <a href="/books/${slug}/" style="flex-shrink: 0;">
                                      <img src="${cover}" alt="${title}"
                                           style="width: 80px; height: 120px; object-fit: cover; border-radius: 0.5rem;">
                                  </a>
                                  <div style="flex: 1;">
                                      <h3 style="margin-bottom: 0.25rem; font-size: 1rem;">
                                          <a href="/books/${slug}/" style="text-decoration: none; color: inherit;">
                                              ${title}
                                          </a>
                                      </h3>
                                      ${authors ? `<div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem;">
                                          ${authors}
                                      </div>` : ''}
                                      ${year ? `<div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.5rem;">
                                          NƒÉm xu·∫•t b·∫£n: ${year}
                                      </div>` : ''}

                                      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                          <div class="rating" data-rating="${rating}"></div>
                                          <span style="font-size: 0.875rem; color: #64748b;">
                                              ${rating.toFixed ? rating.toFixed(1) : rating}/5 (${ratingCount} ƒë√°nh gi√°)
                                          </span>
                                      </div>

                                      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                          <a href="/books/${slug}/" class="btn btn-sm btn-primary">
                                              Xem chi ti·∫øt
                                          </a>
                                          <button type="button"
                                                  class="btn btn-sm btn-outline"
                                                  onclick="removeFromShelf(${book.id}, this)">
                                              X√≥a kh·ªèi k·ªá
                                          </button>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      `;
                  }).join('')}
              </div>
          `;

          // Render sao rating
          booksEl.querySelectorAll('[data-rating]').forEach(el => {
              const value = parseFloat(el.dataset.rating || '0');
              if (!isNaN(value) && window.BookReview && BookReview.renderStars) {
                  BookReview.renderStars(value, el);
              }
          });
      }

      // H√†m xo√° s√°ch kh·ªèi k·ªá (global ƒë·ªÉ d√πng trong onclick)
      window.removeFromShelf = function (bookId, buttonEl) {
          if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s√°ch n√†y kh·ªèi k·ªá?')) {
              return;
          }

          const cardEl = buttonEl.closest('.book-card');
          buttonEl.disabled = true;

          fetch(`/api/shelves/${shelfId}/books/${bookId}/`, {
              method: 'DELETE',
              headers: {
                  'X-CSRFToken': BookReview.utils.getCsrfToken()
              }
          })
          .then(res => {
              if (!res.ok) {
                  throw new Error('L·ªói server');
              }
              if (cardEl) {
                  cardEl.remove();
              }
          })
          .catch(err => {
              console.error(err);
              alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
              buttonEl.disabled = false;
          });
      };

      // Load d·ªØ li·ªáu k·ªá t·ª´ API
      function loadShelf() {
          headerEl.innerHTML = '<p>ƒêang t·∫£i k·ªá s√°ch...</p>';
          booksEl.innerHTML = '';

          fetch(`/api/shelves/${shelfId}/`)
              .then(res => {
                  if (res.status === 404) {
                      headerEl.innerHTML = `
                          <div style="padding: 3rem; text-align: center; color: #ef4444;">
                              <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                              <h1 style="font-size: 1.5rem; margin-bottom: 0.5rem;">K·ªá s√°ch kh√¥ng t·ªìn t·∫°i</h1>
                              <p style="color: #64748b;">K·ªá s√°ch n√†y kh√¥ng t·ªìn t·∫°i ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn xem.</p>
                          </div>
                      `;
                      return null;
                  }
                  if (!res.ok) {
                      throw new Error(`HTTP error! status: ${res.status}`);
                  }
                  return res.json();
              })
              .then(data => {
                  if (!data) return;
                  renderShelfHeader(data);
                  // Handle both direct items array and nested structure
                  const items = data.items || data.shelf_items || [];
                  renderBooks(Array.isArray(items) ? items : []);
              })
              .catch(err => {
                  console.error('Error loading shelf:', err);
                  headerEl.innerHTML = `
                      <div style="padding: 3rem; text-align: center; color: #ef4444;">
                          <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                          <h1 style="font-size: 1.5rem; margin-bottom: 0.5rem;">C√≥ l·ªói x·∫£y ra</h1>
                          <p style="color: #64748b;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu k·ªá s√°ch. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                      </div>
                  `;
                  booksEl.innerHTML = '';
              });
      }

      loadShelf();
  });
</script>

<style>
  .grid-3 {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.25rem;
  }

  .card {
    border-radius: 0.75rem;
    background: white;
    border: 1px solid #e2e8f0;
    box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
  }

  .card-body {
    padding: 1rem 1.25rem;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
    transition: all 0.2s ease;
  }

  /* N√∫t nh·ªè */
  .btn.btn-sm {
    padding: 0.25rem 0.6rem;
    font-size: 0.8rem;
  }
</style>
{% endblock %}
