{% extends 'base.html' %}
{% load static %}

{% block title %}Đặt lại mật khẩu - BookReview.vn{% endblock %}

{% block content %}
<div class="container" style="max-width: 500px; padding-top: 3rem;">
    <div class="card">
        <div class="card-header" style="text-align: center;">
            {% if valid %}
                <h1>Đặt lại mật khẩu</h1>
                <p style="color: #64748b; margin: 0;">Nhập mật khẩu mới của bạn</p>
            {% else %}
                <h1 style="color: #ef4444;">Liên kết không hợp lệ</h1>
                <p style="color: #64748b; margin: 0;">{{ error|default:"Liên kết đặt lại mật khẩu không hợp lệ hoặc đã hết hạn." }}</p>
            {% endif %}
        </div>
        <div class="card-body">
            {% if valid %}
                <form id="password-reset-confirm-form">
                    {% csrf_token %}
                    <input type="hidden" name="token" value="{{ token }}">
                    
                    <div id="alert-container"></div>
                    
                    <div class="form-group">
                        <label for="id_password" class="form-label">Mật khẩu mới</label>
                        <input type="password" 
                               name="password" 
                               id="id_password" 
                               class="form-input" 
                               placeholder="Mật khẩu mới"
                               required
                               autofocus>
                        <div class="form-help">
                            Mật khẩu phải có ít nhất 8 ký tự
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_password_confirm" class="form-label">Xác nhận mật khẩu</label>
                        <input type="password" 
                               name="password_confirm" 
                               id="id_password_confirm" 
                               class="form-input" 
                               placeholder="Xác nhận mật khẩu"
                               required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Đặt lại mật khẩu
                    </button>
                </form>
            {% else %}
                <div style="text-align: center;">
                    <p style="color: #64748b; margin-bottom: 30px;">
                        Vui lòng yêu cầu gửi lại liên kết đặt lại mật khẩu.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <a href="{% url 'password_reset' %}" class="button" style="background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: 600;">
                            Yêu cầu lại
                        </a>
                        <a href="{% url 'home' %}" class="button" style="background-color: #64748b; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: 600;">
                            Về trang chủ
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if valid %}
<script>
document.getElementById('password-reset-confirm-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        token: formData.get('token'),
        password: formData.get('password'),
        password_confirm: formData.get('password_confirm')
    };
    
    const submitButton = this.querySelector('button[type="submit"]');
    const alertContainer = document.getElementById('alert-container');
    
    // Validate passwords match
    if (data.password !== data.password_confirm) {
        alertContainer.innerHTML = `
            <div class="alert alert-error" role="alert">
                <strong>Lỗi!</strong> Mật khẩu không khớp.
            </div>
        `;
        return;
    }
    
    // Disable button
    submitButton.disabled = true;
    submitButton.textContent = 'Đang xử lý...';
    
    try {
        const response = await fetch(`/api/auth/password-reset/${data.token}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': BookReview.utils.getCsrfToken()
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alertContainer.innerHTML = `
                <div class="alert alert-success" role="alert">
                    <strong>Thành công!</strong> ${result.message || 'Mật khẩu đã được đặt lại thành công.'}
                </div>
            `;
            setTimeout(() => {
                window.location.href = '/login/';
            }, 2000);
        } else {
            alertContainer.innerHTML = `
                <div class="alert alert-error" role="alert">
                    <strong>Lỗi!</strong> ${result.error || result.message || 'Có lỗi xảy ra. Vui lòng thử lại.'}
                </div>
            `;
            submitButton.disabled = false;
            submitButton.textContent = 'Đặt lại mật khẩu';
        }
    } catch (err) {
        console.error('Password reset confirm error:', err);
        alertContainer.innerHTML = `
            <div class="alert alert-error" role="alert">
                <strong>Lỗi!</strong> Có lỗi xảy ra. Vui lòng thử lại.
            </div>
        `;
        submitButton.disabled = false;
        submitButton.textContent = 'Đặt lại mật khẩu';
    }
});
</script>
{% endif %}
{% endblock %}

