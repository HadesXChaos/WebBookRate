{% extends 'base.html' %}
{% load static %}

{% block title %}Đăng ký - BookReview.vn{% endblock %}

{% block content %}
<div class="container" style="max-width: 500px; padding-top: 3rem;">
    <div class="card">
        <div class="card-header" style="text-align: center;">
            <h1>Đăng ký</h1>
            <p style="color: #64748b; margin: 0;">Tạo tài khoản để bắt đầu đánh giá sách</p>
        </div>
        <div class="card-body">
            <form id="register-form" method="post" action="/api/auth/register/">
                {% csrf_token %}
                
                {% if form.errors %}
                <div class="alert alert-error" role="alert">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="form-group">
                    <label for="id_username" class="form-label">Tên người dùng</label>
                    <input type="text" 
                           name="username" 
                           id="id_username" 
                           class="form-input" 
                           placeholder="Tên người dùng"
                           required
                           autofocus
                           minlength="3"
                           maxlength="30">
                    <div class="form-help">Từ 3 đến 30 ký tự, chỉ chứa chữ cái, số và dấu gạch dưới</div>
                </div>
                
                <div class="form-group">
                    <label for="id_email" class="form-label">Email</label>
                    <input type="email" 
                           name="email" 
                           id="id_email" 
                           class="form-input" 
                           placeholder="email@example.com"
                           required>
                </div>
                
                <div class="form-group">
                    <label for="id_password" class="form-label">Mật khẩu</label>
                    <input type="password" 
                           name="password" 
                           id="id_password" 
                           class="form-input" 
                           placeholder="Mật khẩu"
                           required
                           minlength="8">
                    <div class="form-help">Tối thiểu 8 ký tự</div>
                </div>
                
                <div class="form-group">
                    <label for="id_password_confirm" class="form-label">Xác nhận mật khẩu</label>
                    <input type="password" 
                           name="password_confirm" 
                           id="id_password_confirm" 
                           class="form-input" 
                           placeholder="Nhập lại mật khẩu"
                           required>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: start; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="terms" required style="width: auto; margin-top: 0.25rem;">
                        <span>Tôi đồng ý với <a href="/terms/" target="_blank">Điều khoản sử dụng</a> và <a href="/privacy/" target="_blank">Chính sách bảo mật</a></span>
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Đăng ký
                </button>
            </form>
            
            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                <p style="color: #64748b; margin-bottom: 1rem;">Hoặc đăng ký bằng</p>
                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                    <button class="btn btn-outline" onclick="registerWithGoogle()">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M19.6 10.23c0-.82-.07-1.64-.2-2.44H10v4.62h5.4c-.23 1.13-.9 2.09-1.92 2.73v2.43h3.1c1.81-1.67 2.86-4.13 2.86-7.34z" fill="#4285F4"/>
                            <path d="M10 20c2.58 0 4.74-.86 6.32-2.33l-3.1-2.43c-.86.6-1.96.95-3.22.95-2.48 0-4.58-1.68-5.33-3.93H1.28v2.5C2.86 17.78 6.2 20 10 20z" fill="#34A853"/>
                            <path d="M4.67 11.19c-.2-.6-.31-1.24-.31-1.89s.11-1.29.31-1.89V5.91H1.28C.64 7.15.33 8.52.33 9.9s.31 2.75.95 3.99l3.39-2.7z" fill="#FBBC05"/>
                            <path d="M10 3.68c1.4 0 2.65.48 3.64 1.42l2.72-2.72C14.74.89 12.58 0 10 0 6.2 0 2.86 2.22 1.28 5.91l3.39 2.62C5.42 5.36 7.52 3.68 10 3.68z" fill="#EA4335"/>
                        </svg>
                        Google
                    </button>
                    <button class="btn btn-outline" onclick="registerWithFacebook()">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M18 10a8 8 0 1 0-9 7.93v-5.61H5.9v-2.32h3.1V8.41c0-3.06 1.82-4.75 4.61-4.75 1.33 0 2.73.24 2.73.24v3H13.7c-1.5 0-1.97.93-1.97 1.89v2.25h3.33l-.53 2.32H11.73v5.61A8 8 0 0 0 18 10z"/>
                        </svg>
                        Facebook
                    </button>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 1.5rem;">
                <p style="color: #64748b;">
                    Đã có tài khoản? 
                    <a href="/login/" style="font-weight: 500;">Đăng nhập ngay</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('register-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const password = formData.get('password');
    const passwordConfirm = formData.get('password_confirm');
    
    // Validate passwords match
    if (password !== passwordConfirm) {
        BookReview.utils.showAlert('Mật khẩu xác nhận không khớp!', 'error');
        return;
    }
    
    const data = {
        username: formData.get('username'),
        email: formData.get('email'),
        password: password,
        password_confirm: passwordConfirm
    };
    
    try {
        const response = await fetch('/api/auth/register/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': BookReview.utils.getCsrfToken()
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            BookReview.utils.showAlert('Đăng ký thành công! Vui lòng kiểm tra email để xác thực tài khoản.', 'success');
            setTimeout(() => {
                window.location.href = '/login/';
            }, 2000);
        } else {
            const errorMsg = result.error || result.detail || 'Đăng ký thất bại. Vui lòng thử lại.';
            BookReview.utils.showAlert(errorMsg, 'error');
        }
    } catch (err) {
        console.error('Register error:', err);
        BookReview.utils.showAlert('Có lỗi xảy ra. Vui lòng thử lại.', 'error');
    }
});

function registerWithGoogle() {
    window.location.href = '/api/auth/oauth/google/';
}

function registerWithFacebook() {
    window.location.href = '/api/auth/oauth/facebook/';
}
</script>
{% endblock %}

