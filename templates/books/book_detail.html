{% extends 'base.html' %}
{% load static %}

{% block title %}{{ book.title }} - BookReview.vn{% endblock %}
{% block meta_description %}{{ book.description|truncatewords:30 }}{% endblock %}
{% block og_title %}{{ book.title }}{% endblock %}
{% block og_description %}{{ book.description|truncatewords:30 }}{% endblock %}
{% block og_image %}{% if book.cover %}{{ book.cover.url }}{% endif %}{% endblock %}
{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block canonical_url %}<link rel="canonical" href="{{ request.build_absolute_uri }}">{% endblock %}

{% block extra_css %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Book",
  "name": "{{ book.title|escapejs }}",
  "description": "{{ book.description|truncatewords:50|escapejs }}",
  {% if book.cover %}"image": "{{ request.scheme }}://{{ request.get_host }}{{ book.cover.url }}",{% endif %}
  "author": [
    {% for author in book.authors.all %}{
      "@type": "Person",
      "name": "{{ author.name|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ],
  {% if book.publisher %}"publisher": {
    "@type": "Organization",
    "name": "{{ book.publisher.name|escapejs }}"
  },{% endif %}
  {% if book.year %}"datePublished": "{{ book.year }}",{% endif %}
  {% if book.isbn %}"isbn": "{{ book.isbn }}",{% endif %}
  {% if book.pages %}"numberOfPages": {{ book.pages }},{% endif %}
  {% if book.avg_rating %}"aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ book.avg_rating }}",
    "ratingCount": {{ book.rating_count|default:0 }},
    "bestRating": "5",
    "worstRating": "1"
  },{% endif %}
  "url": "{{ request.build_absolute_uri }}"
}
</script>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Book Header -->
    <section class="book-header animate-slide-up" style="display: flex; gap: 2rem; margin-bottom: 2rem; padding: 2rem 0;" data-aos="fade-up">
        <div class="book-cover-large hover-scale" style="flex-shrink: 0;">
            <img src="{% if book.cover %}{{ book.cover.url }}{% else %}{% static 'images/default-book.svg' %}{% endif %}" 
                 alt="{{ book.title }}" 
                 class="img-scale-in"
                 style="width: 200px; height: auto; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;">
        </div>
        
        <div class="book-info-large" style="flex: 1;">
            <h1 style="margin-bottom: 0.5rem;">{{ book.title }}</h1>
            
            <div class="book-authors" style="margin-bottom: 1rem;">
                <span style="color: #64748b;">B·ªüi</span>
                {% for author in book.authors.all %}
                    <a href="/books/authors/{{ author.slug }}/" style="color: #2563eb; font-weight: 500;">{{ author.name }}</a>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </div>
            
            <div class="book-rating" style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
                <div class="rating-stars" data-rating="{{ book.avg_rating|default:0 }}"></div>
                <span style="font-size: 1.25rem; font-weight: 600;">{{ book.avg_rating|default:0|floatformat:1 }}</span>
                <span style="color: #64748b;">({{ book.rating_count|default:0 }} ƒë√°nh gi√°)</span>
            </div>
            
            <div class="book-meta" style="margin-bottom: 1.5rem; color: #64748b; font-size: 0.9375rem;">
                {% if book.year %}NƒÉm xu·∫•t b·∫£n: {{ book.year }}<br>{% endif %}
                {% if book.pages %}S·ªë trang: {{ book.pages }}<br>{% endif %}
                {% if book.publisher %}Nh√† xu·∫•t b·∫£n: <a href="/books/publishers/{{ book.publisher.slug }}/">{{ book.publisher.name }}</a><br>{% endif %}
                {% if book.genres.all %}
                    Th·ªÉ lo·∫°i: 
                    {% for genre in book.genres.all %}
                        <a href="/books/genres/{{ genre.slug }}/">{{ genre.name }}</a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            <div class="book-actions" style="display: flex; gap: 1rem; flex-wrap: wrap;"> 
            {% if book.link_buy %}
                <a href="{{ book.link_buy }}" target="_blank" rel="nofollow noopener" class="btn btn-animated hover-lift" 
                   style="background-color: #10b981; color: white; border: 1px solid #10b981; display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; transition: all 0.3s ease;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 0 1-8 0"></path>
                    </svg>
                    Link Mua
                </a>
            {% endif %}
            
            {% if user.is_authenticated %}
                <button class="btn btn-primary btn-animated hover-lift" id="add-to-shelf-btn" style="transition: all 0.3s ease;">
                    Th√™m v√†o k·ªá s√°ch
                </button>
                <a href="{% url 'review_editor' %}?slug={{ book.slug }}" class="btn btn-outline btn-animated hover-lift" style="transition: all 0.3s ease;">
                    Vi·∫øt review
                </a>
                <button class="btn btn-outline btn-animated hover-lift" id="follow-book-btn" data-book-id="{{ book.id }}" style="transition: all 0.3s ease;">
                    <span id="follow-text">Theo d√µi</span>
                </button>
            {% else %}
                <div class="book-actions">
                    <a href="/login/" class="btn btn-primary btn-animated hover-lift" style="transition: all 0.3s ease;">ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°</a>
                </div>
            {% endif %}
            </div>
        </div>
    </section>
    
    <!-- Book Description -->
    {% if book.description %}
    <section class="book-description" style="margin-bottom: 2rem;">
        <div class="card">
            <div class="card-body">
                <h2 style="margin-bottom: 1rem;">Gi·ªõi thi·ªáu</h2>
                <p style="line-height: 1.8; color: #475569;">{{ book.description|linebreaks }}</p>
            </div>
        </div>
    </section>
    {% endif %}
    
    <!-- Rating Distribution -->
    <section class="rating-distribution" style="margin-bottom: 2rem;">
        <div class="card">
            <div class="card-body">
                <h2 style="margin-bottom: 1rem;">Ph√¢n b·ªë ƒëi·ªÉm</h2>
                <div id="rating-chart" style="min-height: 200px;">
                    <!-- Chart will be rendered via JavaScript -->
                </div>
            </div>
        </div>
    </section>
    
    <!-- Reviews Section -->
    <section class="reviews-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2>ƒê√°nh gi√° ({{ book.rating_count|default:0 }})</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-sm btn-outline" data-sort="latest">M·ªõi nh·∫•t</button>
                <button class="btn btn-sm btn-outline" data-sort="rating">ƒêi·ªÉm cao</button>
                <button class="btn btn-sm btn-outline" data-sort="helpful">H·ªØu √≠ch nh·∫•t</button>
            </div>
        </div>
        
        <div id="reviews-list">
            <!-- Reviews will be loaded via JavaScript -->
            <div class="loading">ƒêang t·∫£i...</div>
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn btn-outline" id="load-more-reviews">T·∫£i th√™m</button>
        </div>
    </section>
</div>

<!-- Add to Shelf Modal -->
{% if user.is_authenticated %}
<div id="shelf-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div class="card-header">
            <h3>Th√™m v√†o k·ªá s√°ch</h3>
        </div>
        <div class="card-body" id="shelf-list">
            <!-- Shelves will be loaded via JavaScript -->
            <div class="loading">ƒêang t·∫£i...</div>
        </div>
        <div class="card-footer">
            <button class="btn btn-outline" id="close-shelf-modal">ƒê√≥ng</button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookId = {{ book.id }};
    
    // Render stars
    document.querySelectorAll('[data-rating]').forEach(el => {
        BookReview.renderStars(parseFloat(el.dataset.rating), el);
    });
    
    // Load reviews
    function loadReviews(sort = 'latest', page = 1) {
        const sortParam = sort === 'latest' ? '-created_at' : sort === 'rating' ? '-rating' : '-like_count';
        fetch(`/api/reviews/?book=${bookId}&ordering=${sortParam}&page=${page}`)
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('reviews-list');
                if (data.results && data.results.length > 0) {
                    container.innerHTML = data.results.map(review => `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div class="card-body">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <img src="${review.user?.profile?.avatar || '/static/images/default-avatar.svg'}" 
                                         alt="${review.user?.username}" 
                                         style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                                    <div style="flex: 1;">
                                        <div><strong><a href="/users/${review.user?.username}/">${review.user?.username}</a></strong></div>
                                        <div class="rating-stars" data-rating="${review.rating || 0}"></div>
                                        <div style="color: #64748b; font-size: 0.875rem;">${new Date(review.created_at).toLocaleDateString('vi-VN')}</div>
                                    </div>
                                </div>
                                <h3><a href="/reviews/${review.id}/">${review.title}</a></h3>
                                <div style="color: #475569; line-height: 1.8;">${review.body_html || review.body || ''}</div>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                                    <button class="icon-button" data-like-url="/api/reviews/${review.id}/like/">
                                        ${review.is_liked ? '‚ù§Ô∏è' : 'ü§ç'} <span data-like-count>${review.like_count || 0}</span>
                                    </button>
                                    <a href="/reviews/${review.id}/#comments" style="color: #64748b;">üí¨ ${review.comment_count || 0} b√¨nh lu·∫≠n</a>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Render stars and init like buttons
                    container.querySelectorAll('[data-rating]').forEach(el => {
                        BookReview.renderStars(parseFloat(el.dataset.rating), el);
                    });
                    
                    // Re-init like buttons
                    document.querySelectorAll('[data-like-url]').forEach(btn => {
                        btn.addEventListener('click', async function(e) {
                            e.preventDefault();
                            const url = this.dataset.likeUrl;
                            const countEl = this.querySelector('[data-like-count]');
                            const isLiked = this.innerHTML.includes('‚ù§Ô∏è');
                            
                            try {
                                const method = isLiked ? 'DELETE' : 'POST';
                                await BookReview.utils.apiRequest(url, method);
                                this.innerHTML = isLiked ? `ü§ç <span data-like-count>${parseInt(countEl.textContent) - 1}</span>` : `‚ù§Ô∏è <span data-like-count>${parseInt(countEl.textContent) + 1}</span>`;
                            } catch (err) {
                                BookReview.utils.showAlert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>';
                }
            })
            .catch(err => {
                console.error('Error loading reviews:', err);
                document.getElementById('reviews-list').innerHTML = '<p>C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu.</p>';
            });
    }
    
    // Sort buttons
    document.querySelectorAll('[data-sort]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-sort]').forEach(b => b.classList.remove('btn-primary'));
            this.classList.add('btn-primary');
            loadReviews(this.dataset.sort);
        });
    });
    
    // Initial load
    loadReviews();
    

{% if user.is_authenticated %}
    const shelfModal = document.getElementById('shelf-modal');
    const addToShelfBtn = document.getElementById('add-to-shelf-btn');
    const shelfListContainer = document.getElementById('shelf-list');

    // H√†m ki·ªÉm tra tr·∫°ng th√°i ban ƒë·∫ßu c·ªßa n√∫t b·∫•m
    function checkBookStatus() {
        // G·ªçi API l·∫•y danh s√°ch k·ªá k√®m tr·∫°ng th√°i s√°ch n√†y
        fetch(`/api/shelves/?check_book_id=${bookId}`)
            .then(res => res.json())
            .then(data => {
                const shelves = Array.isArray(data) ? data : (data.results || []);
                
                // Ki·ªÉm tra xem s√°ch c√≥ n·∫±m trong √≠t nh·∫•t 1 k·ªá n√†o kh√¥ng
                const isSaved = shelves.some(shelf => shelf.has_book);
                
                // C·∫≠p nh·∫≠t giao di·ªán n√∫t b·∫•m
                if (isSaved) {
                    addToShelfBtn.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"></path>
                        </svg>
                        ƒê√£ l∆∞u v√†o k·ªá
                    `;
                    addToShelfBtn.classList.add('btn-success');
                } else {
                    addToShelfBtn.textContent = "Th√™m v√†o k·ªá s√°ch";
                    addToShelfBtn.classList.remove('btn-success');
                }
            });
    }
    
    // G·ªçi ngay khi load trang ƒë·ªÉ update n√∫t b·∫•m
    checkBookStatus();

    // S·ª± ki·ªán m·ªü Modal
    addToShelfBtn.addEventListener('click', function() {
        shelfListContainer.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
        shelfModal.style.display = 'flex';

        fetch(`/api/shelves/?check_book_id=${bookId}`)
            .then(res => res.json())
            .then(data => {
                const shelves = Array.isArray(data) ? data : (data.results || []);
                
                if (shelves.length > 0) {
                    shelfListContainer.innerHTML = shelves.map(shelf => `
                        <label class="shelf-item-row" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer;">
                            <input type="checkbox" 
                                   style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;"
                                   ${shelf.has_book ? 'checked' : ''} 
                                   onchange="toggleShelf(${shelf.id}, ${bookId}, this)">
                            
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 15px;">${shelf.name}</div>
                                <div style="font-size: 13px; color: #666;">
                                    ${shelf.visibility === 'private' ? 'üîí Ri√™ng t∆∞' : 'üåê C√¥ng khai'} ‚Ä¢ ${shelf.book_count} cu·ªën
                                </div>
                            </div>
                        </label>
                    `).join('');
                } else {
                    shelfListContainer.innerHTML = '<p>B·∫°n ch∆∞a c√≥ k·ªá n√†o. <a href="/shelves/">ƒê·∫øn k·ªá s√°ch t·∫°o ngay!</a></p>';
                }
            });
    });

    // H√†m Toggle (Th√™m/X√≥a)
    window.toggleShelf = function(shelfId, bookId, checkbox) {
        checkbox.disabled = true;
        const originalState = !checkbox.checked;

        const method = checkbox.checked ? 'POST' : 'DELETE';
        
        fetch(`/api/shelves/${shelfId}/books/${bookId}/`, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': BookReview.utils.getCsrfToken()
            }
        })
        .then(res => {
            if (!res.ok) throw new Error('L·ªói server');            
            checkBookStatus();
        })
        .catch(err => {
            console.error(err);
            alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
            checkbox.checked = originalState; // Ho√†n t√°c checkbox v·ªÅ nh∆∞ c≈©
        })
        .finally(() => {
            checkbox.disabled = false; // M·ªü kh√≥a
        });
    }

    // ƒê√≥ng Modal
    document.getElementById('close-shelf-modal').addEventListener('click', () => {
        shelfModal.style.display = 'none';
    });
{% endif %}
});
</script>
{% endblock %}

