{% extends 'base.html' %} {% load static %} {% block title %}{{ genre.name }} -
Th·ªÉ lo·∫°i s√°ch{% endblock %} {% block meta_description %}Kh√°m ph√° {{ genre.name
}} ‚Äì {{ genre.description|truncatewords:25 }}{% endblock %} {% block content %}
<section class="genre-detail-hero">
  <div class="container">
    <a href="{% url 'genre_directory' %}" class="back-link">
      ‚Üê Tr·ªü l·∫°i danh s√°ch th·ªÉ lo·∫°i
    </a>

    <div class="genre-detail-header">
      <div>
        <p class="eyebrow-label">Th·ªÉ lo·∫°i</p>
        <h1>{{ genre.name }}</h1>
        {% if genre.description %}
        <p class="sub-text">{{ genre.description }}</p>
        {% else %}
        <p class="sub-text">
          Th·ªÉ lo·∫°i n√†y ƒëang ƒë∆∞·ª£c c·ªông ƒë·ªìng BookReview.vn c·∫≠p nh·∫≠t m√¥ t·∫£.
        </p>
        {% endif %}
      </div>
      <div class="genre-detail-stats" id="genre-detail-stats">
        <div>
          <span class="stat-label">S√°ch c√≥ trong th·ªÉ lo·∫°i</span>
          <strong id="stat-book-count">--</strong>
        </div>
        <div>
          <span class="stat-label">ƒêi·ªÉm trung b√¨nh</span>
          <strong id="stat-rating">--</strong>
        </div>
        <div>
          <span class="stat-label">ƒê√°nh gi√° m·ªõi tu·∫ßn n√†y</span>
          <strong id="stat-new-reviews">--</strong>
        </div>
      </div>
    </div>

    <div class="genre-detail-controls">
      <div class="input-icon" style="max-width: 320px">
        <!-- <svg viewBox="0 0 20 20" aria-hidden="true"><path d="M9 17a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm10 2-4.35-4.35"/></svg> -->
        <input
          type="search"
          placeholder="L·ªçc theo t√™n s√°ch ho·∫∑c t√°c gi·∫£..."
          id="genre-book-search"
        />
      </div>
      <div class="genre-filters">
        <button class="chip chip--active" data-order="-avg_rating">
          ƒêi·ªÉm cao
        </button>
        <button class="chip" data-order="-created_at">M·ªõi nh·∫•t</button>
        <button class="chip" data-order="-rating_count">Nhi·ªÅu ƒë√°nh gi√°</button>
      </div>
    </div>
  </div>
</section>

<section class="genre-book-section">
  <div class="container">
    <div id="genre-book-grid" class="genre-book-grid">
      {% for _ in "1234" %}
      <article class="book-card skeleton">
        <div class="skeleton-line skeleton-title"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
      </article>
      {% endfor %}
    </div>
    <div class="load-more-wrapper">
      <button
        class="btn btn-outline"
        id="genre-load-more"
        style="display: none"
      >
        T·∫£i th√™m s√°ch
      </button>
    </div>
  </div>
</section>

<section class="genre-insights">
  <div class="container">
    <div class="insight-card">
      <div>
        <h2>G·ª£i √Ω ƒë·ªçc nhanh</h2>
        <p class="sub-text">
          Ch√∫ng t√¥i ph√¢n lo·∫°i b·∫£ng x·∫øp h·∫°ng ƒë·ªÉ b·∫°n d·ªÖ ch·ªçn l·ª±a.
        </p>
      </div>
      <div class="insight-tags" id="genre-insight-tags"></div>
    </div>
  </div>
</section>

{{ genre.slug|json_script:"genre-slug" }} {% if user.is_authenticated %}
<div
  id="shelf-modal"
  style="
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  "
>
  <div
    class="card"
    style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto"
  >
    <div class="card-header">
      <h3>Th√™m v√†o k·ªá s√°ch</h3>
    </div>
    <div class="card-body" id="shelf-list">
      <div class="loading">ƒêang t·∫£i...</div>
    </div>
    <div class="card-footer">
      <button class="btn btn-outline" id="close-shelf-modal">ƒê√≥ng</button>
    </div>
  </div>
</div>
{% endif %} {% endblock %} {% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const slug = JSON.parse(document.getElementById('genre-slug').textContent);
      const grid = document.getElementById('genre-book-grid');
      const loadMoreBtn = document.getElementById('genre-load-more');
      const searchInput = document.getElementById('genre-book-search');
      const filterButtons = document.querySelectorAll('[data-order]');
      const statBook = document.getElementById('stat-book-count');
      const statRating = document.getElementById('stat-rating');
      const statReviews = document.getElementById('stat-new-reviews');
      const insightTags = document.getElementById('genre-insight-tags');

      const apiBase = `/api/books/genres/${slug}/`;

      // --- 1. KH·ªûI T·∫†O BI·∫æN D√ôNG CHUNG ---
      const isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
      let shelfModal = null; // S·∫Ω kh·ªüi t·∫°o n·∫øu user ƒë√£ ƒëƒÉng nh·∫≠p
      let shelfListContainer = null;
      let currentBookId = null;

      // Helper CSRF
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }

      // --- 2. LOGIC C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI N√öT (QUAN TR·ªåNG) ---
      // H√†m n√†y s·∫Ω ch·∫°y sau khi s√°ch ƒë∆∞·ª£c render ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i "ƒê√£ l∆∞u"
      function checkAndUpdateButton(bookId) {
          if (!isAuthenticated) return;

          const btn = document.querySelector(`button[data-book="${bookId}"]`);
          if (!btn) return;

          // G·ªçi API ki·ªÉm tra s√°ch n√†y
          fetch(`/api/shelves/?check_book_id=${bookId}`)
              .then(res => res.json())
              .then(data => {
                  const shelves = Array.isArray(data) ? data : (data.results || []);
                  // Ki·ªÉm tra xem s√°ch c√≥ trong √≠t nh·∫•t 1 k·ªá n√†o kh√¥ng
                  const isSaved = shelves.some(shelf => shelf.has_book);

                  if (isSaved) {
                      btn.innerHTML = '‚úì ƒê√£ l∆∞u';
                      btn.classList.add('btn-success');
                      btn.classList.remove('btn-outline');
                  } else {
                      btn.innerHTML = '+ K·ªá s√°ch';
                      btn.classList.remove('btn-success');
                      btn.classList.add('btn-outline');
                  }
              })
              .catch(() => {});
      }

      // --- 3. LOGIC MODAL & TOGGLE ---
      if (isAuthenticated) {
          // T·∫°o Modal HTML ƒë·ªông m·ªôt l·∫ßn duy nh·∫•t
          document.body.insertAdjacentHTML('beforeend', `
              <div id="shelf-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
                  <div class="card" style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                      <div class="card-header"><h3>Th√™m v√†o k·ªá s√°ch</h3></div>
                      <div class="card-body" id="shelf-list"><div class="loading">ƒêang t·∫£i...</div></div>
                      <div class="card-footer"><button class="btn btn-outline" id="close-shelf-modal">ƒê√≥ng</button></div>
                  </div>
              </div>
          `);

          shelfModal = document.getElementById('shelf-modal');
          shelfListContainer = document.getElementById('shelf-list');

          // ƒê√≥ng modal
          document.getElementById('close-shelf-modal').addEventListener('click', () => {
              shelfModal.style.display = 'none';
              // Khi ƒë√≥ng modal, c·∫≠p nh·∫≠t l·∫°i n√∫t b·∫•m b√™n ngo√†i cho ch√≠nh x√°c
              if(currentBookId) checkAndUpdateButton(currentBookId);
          });

          // B·∫Øt s·ª± ki·ªán click n√∫t "+ K·ªá s√°ch"
          document.body.addEventListener('click', function(e) {
              const btn = e.target.closest('button[data-action="shelf"]');
              if (btn) {
                  e.preventDefault();
                  currentBookId = btn.dataset.book;

                  shelfListContainer.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
                  shelfModal.style.display = 'flex';

                  fetch(`/api/shelves/?check_book_id=${currentBookId}`)
                      .then(res => res.json())
                      .then(data => {
                          const shelves = Array.isArray(data) ? data : (data.results || []);
                          if (shelves.length > 0) {
                              shelfListContainer.innerHTML = shelves.map(shelf => `
                                  <label class="shelf-item-row" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer;">
                                      <input type="checkbox"
                                             style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;"
                                             ${shelf.has_book ? 'checked' : ''}
                                             onchange="toggleShelf(${shelf.id}, ${currentBookId}, this)">
                                      <div style="flex: 1;">
                                          <div style="font-weight: 600; font-size: 15px;">${shelf.name}</div>
                                          <div style="font-size: 13px; color: #666;">
                                              ${shelf.visibility === 'private' ? 'üîí Ri√™ng t∆∞' : 'üåê C√¥ng khai'} ‚Ä¢ ${shelf.book_count} cu·ªën
                                          </div>
                                      </div>
                                  </label>
                              `).join('');
                          } else {
                              shelfListContainer.innerHTML = '<p>B·∫°n ch∆∞a c√≥ k·ªá n√†o. <a href="/shelves/">T·∫°o ngay!</a></p>';
                          }
                      });
              }
          });

          window.toggleShelf = function(shelfId, bookId, checkbox) {
              checkbox.disabled = true;
              const originalState = !checkbox.checked;
              const method = checkbox.checked ? 'POST' : 'DELETE';

              fetch(`/api/shelves/${shelfId}/books/${bookId}/`, {
                  method: method,
                  headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
              })
              .then(res => {
                  if (!res.ok) throw new Error('L·ªói server');
                  // Th√†nh c√¥ng th√¨ g·ªçi h√†m update n√∫t b√™n ngo√†i ngay l·∫≠p t·ª©c ƒë·ªÉ ƒë·ªìng b·ªô
                  checkAndUpdateButton(bookId);
              })
              .catch(err => {
                  console.error(err);
                  checkbox.checked = originalState;
              })
              .finally(() => { checkbox.disabled = false; });
          }
      } else {
          // Ch∆∞a ƒëƒÉng nh·∫≠p -> Chuy·ªÉn h∆∞·ªõng
          document.body.addEventListener('click', function(e) {
              if (e.target.closest('button[data-action="shelf"]')) {
                  e.preventDefault();
                  window.location.href = '/login/?next=' + window.location.pathname;
              }
          });
      }

      // --- 4. LOGIC RENDER S√ÅCH ---
      const state = {
          nextUrl: apiBase,
          items: [],
          filtered: [],
          order: '-avg_rating',
          search: '',
      };

      function setLoading(isLoading) {
          if (isLoading) grid.classList.add('is-loading');
          else grid.classList.remove('is-loading');
      }

      function formatAuthors(authors) {
          if (!Array.isArray(authors) || !authors.length) return 'ƒêang c·∫≠p nh·∫≠t t√°c gi·∫£';
          return authors.map(author => author.name).join(', ');
      }

      function updateStats(books) {
          const count = books.length;
          const ratingSum = books.reduce((sum, book) => sum + (parseFloat(book.avg_rating) || 0), 0);
          const reviewSum = books.reduce((sum, book) => sum + (book.rating_count || 0), 0);
          statBook.textContent = count;
          statRating.textContent = count ? (ratingSum / count).toFixed(1) : '‚Äî';
          statReviews.textContent = reviewSum;

          const topBooks = [...books].sort((a, b) => (parseFloat(b.avg_rating) || 0) - (parseFloat(a.avg_rating) || 0)).slice(0, 3);
          insightTags.innerHTML = '';
          topBooks.forEach(book => {
              const tag = document.createElement('a');
              tag.href = `/books/${book.slug}/`;
              tag.className = 'insight-pill';
              tag.innerHTML = `<strong>${book.title}</strong><span>${book.avg_rating || '0.0'} ‚òÖ</span>`;
              insightTags.appendChild(tag);
          });
      }

      function renderBooks(books, reset = false) {
          if (reset) grid.innerHTML = '';

          if (!books.length) {
              grid.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ cu·ªën s√°ch n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc hi·ªán t·∫°i.</div>';
              return;
          }

          const fragment = document.createDocumentFragment();
          books.forEach(book => {
              const card = document.createElement('article');
              card.className = 'book-card book-card--genre';
              card.innerHTML = `
                  <a href="/books/${book.slug}/" class="book-card__cover">
                      <img src="${book.cover || '{% static "images/default-book.svg" %}'}" alt="${book.title}">
                  </a>
                  <div class="book-card__body">
                      <a href="/books/${book.slug}/"><h3>${book.title}</h3></a>
                      <p class="book-card__meta">${formatAuthors(book.authors)}</p>
                      <div class="book-card__stats">
                          <span>${book.avg_rating || '0.0'} ‚òÖ</span>
                          <span>${book.rating_count || 0} ƒë√°nh gi√°</span>
                      </div>
                      <div class="book-card__actions">
                          <a href="/books/${book.slug}/" class="btn btn-sm btn-primary">Xem chi ti·∫øt</a>
                          <button class="btn btn-sm btn-outline" data-book="${book.id}" data-action="shelf">+ K·ªá s√°ch</button>
                      </div>
                  </div>
              `;
              fragment.appendChild(card);
          });

          grid.appendChild(fragment);

          // Re-render stars
          grid.querySelectorAll('[data-rating]').forEach(el => {
              BookReview.renderStars(parseFloat(el.dataset.rating), el);
          });

          // --- C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI N√öT "ƒê√É L∆ØU" ---
          if (isAuthenticated) {
              books.forEach(book => {
                  checkAndUpdateButton(book.id);
              });
          }
      }

      function applyFilters() {
          const term = state.search.toLowerCase();
          state.filtered = state.items.filter(book => {
              const matchTitle = book.title?.toLowerCase().includes(term);
              const matchAuthor = book.authors?.some(author => author.name?.toLowerCase().includes(term));
              return term ? (matchTitle || matchAuthor) : true;
          });

          state.filtered.sort((a, b) => {
              switch (state.order) {
                  case '-created_at': return new Date(b.created_at) - new Date(a.created_at);
                  case '-rating_count': return (b.rating_count || 0) - (a.rating_count || 0);
                  default: return (parseFloat(b.avg_rating) || 0) - (parseFloat(a.avg_rating) || 0);
              }
          });

          updateStats(state.filtered);
          renderBooks(state.filtered, true);
      }

      async function fetchBooks(url = apiBase, append = false) {
          try {
              setLoading(true);
              const res = await fetch(url);
              const data = await res.json();
              const payload = data.results ? data.results : data;
              const booksData = payload.books || payload.results || [];

              if (append) state.items = state.items.concat(booksData);
              else state.items = booksData;

              applyFilters();
              state.nextUrl = data.next || null;
              loadMoreBtn.style.display = state.nextUrl ? 'inline-flex' : 'none';
          } catch (error) {
              console.error('Failed to load genre books', error);
              grid.innerHTML = '<div class="empty-state">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.</div>';
          } finally {
              setLoading(false);
          }
      }

      loadMoreBtn.addEventListener('click', () => { if (state.nextUrl) fetchBooks(state.nextUrl, true); });

      searchInput.addEventListener('input', BookReview.utils.debounce(event => {
          state.search = event.target.value.trim();
          applyFilters();
      }, 250));

      filterButtons.forEach(button => {
          button.addEventListener('click', () => {
              filterButtons.forEach(btn => btn.classList.remove('chip--active'));
              button.classList.add('chip--active');
              state.order = button.dataset.order;
              applyFilters();
          });
      });

      fetchBooks(apiBase);
  });
</script>
{% endblock %}
